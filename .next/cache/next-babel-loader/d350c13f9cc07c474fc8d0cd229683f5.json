{"ast":null,"code":"import crypto from 'crypto';\nimport { serialize } from 'cookie';\nimport { selectUserByUsername, insertSession } from '../../db';\nimport { verifyHashMatchesPassword } from '../../hashing';\nexport default async function login(req, res) {\n  // TODO: To secure your application even further,\n  // accept a CSRF token here and verify it\n  // (see pages/register.tsx)\n  const username = req.body.username;\n  const password = req.body.password;\n  const users = await selectUserByUsername(username);\n\n  if (users.length === 0) {\n    console.log('denied login - zero users with that username');\n    res.json({\n      loggedIn: false\n    });\n    return;\n  }\n\n  if (!(await verifyHashMatchesPassword(users[0].password_hash, password))) {\n    console.log(\"denied login - password doesn't match\");\n    res.json({\n      loggedIn: false\n    });\n    return;\n  }\n\n  console.log('logged in');\n  const maxAge = 60 * 60 * 8; // 8 hours\n\n  const token = crypto.randomBytes(24).toString('base64');\n  await insertSession(users[0].id, token);\n  const cookie = serialize('token', token, {\n    maxAge,\n    expires: new Date(Date.now() + maxAge * 1000),\n    // Important for security\n    // Deny cookie access from JavaScript\n    httpOnly: true,\n    // Important for security\n    // Set secure cookies on production\n    secure: false,\n    path: '/',\n    sameSite: 'lax'\n  }); // TODO: In order to prevent your database\n  // from overflowing with sessions, you should\n  // remove the old sessions here.\n\n  res.setHeader('Set-Cookie', cookie);\n  res.json({\n    loggedIn: true\n  });\n}","map":{"version":3,"sources":["/Users/gabrielasanchez/projects/wolfis-trip/pages/api/login.ts"],"names":["crypto","serialize","selectUserByUsername","insertSession","verifyHashMatchesPassword","login","req","res","username","body","password","users","length","console","log","json","loggedIn","password_hash","maxAge","token","randomBytes","toString","id","cookie","expires","Date","now","httpOnly","secure","path","sameSite","setHeader"],"mappings":"AAAA,OAAOA,MAAP,MAAmB,QAAnB;AACA,SAASC,SAAT,QAA0B,QAA1B;AACA,SAASC,oBAAT,EAA+BC,aAA/B,QAAoD,UAApD;AACA,SAAuBC,yBAAvB,QAAwD,eAAxD;AAGA,eAAe,eAAeC,KAAf,CAAqBC,GAArB,EAA0CC,GAA1C,EAAgE;AAC7E;AACA;AACA;AACA,QAAMC,QAAQ,GAAGF,GAAG,CAACG,IAAJ,CAASD,QAA1B;AACA,QAAME,QAAQ,GAAGJ,GAAG,CAACG,IAAJ,CAASC,QAA1B;AACA,QAAMC,KAAK,GAAG,MAAMT,oBAAoB,CAACM,QAAD,CAAxC;;AAEA,MAAIG,KAAK,CAACC,MAAN,KAAiB,CAArB,EAAwB;AACtBC,IAAAA,OAAO,CAACC,GAAR,CAAY,8CAAZ;AACAP,IAAAA,GAAG,CAACQ,IAAJ,CAAS;AAAEC,MAAAA,QAAQ,EAAE;AAAZ,KAAT;AACA;AACD;;AAED,MAAI,EAAE,MAAMZ,yBAAyB,CAACO,KAAK,CAAC,CAAD,CAAL,CAASM,aAAV,EAAyBP,QAAzB,CAAjC,CAAJ,EAA0E;AACxEG,IAAAA,OAAO,CAACC,GAAR,CAAY,uCAAZ;AACAP,IAAAA,GAAG,CAACQ,IAAJ,CAAS;AAAEC,MAAAA,QAAQ,EAAE;AAAZ,KAAT;AACA;AACD;;AAEDH,EAAAA,OAAO,CAACC,GAAR,CAAY,WAAZ;AAEA,QAAMI,MAAM,GAAG,KAAK,EAAL,GAAU,CAAzB,CAtB6E,CAsBjD;;AAC5B,QAAMC,KAAK,GAAGnB,MAAM,CAACoB,WAAP,CAAmB,EAAnB,EAAuBC,QAAvB,CAAgC,QAAhC,CAAd;AAEA,QAAMlB,aAAa,CAACQ,KAAK,CAAC,CAAD,CAAL,CAASW,EAAV,EAAcH,KAAd,CAAnB;AAEA,QAAMI,MAAM,GAAGtB,SAAS,CAAC,OAAD,EAAUkB,KAAV,EAAiB;AACvCD,IAAAA,MADuC;AAEvCM,IAAAA,OAAO,EAAE,IAAIC,IAAJ,CAASA,IAAI,CAACC,GAAL,KAAaR,MAAM,GAAG,IAA/B,CAF8B;AAIvC;AACA;AACAS,IAAAA,QAAQ,EAAE,IAN6B;AAQvC;AACA;AACAC,IAAAA,MAAM,OAViC;AAYvCC,IAAAA,IAAI,EAAE,GAZiC;AAavCC,IAAAA,QAAQ,EAAE;AAb6B,GAAjB,CAAxB,CA3B6E,CA2C7E;AACA;AACA;;AAEAvB,EAAAA,GAAG,CAACwB,SAAJ,CAAc,YAAd,EAA4BR,MAA5B;AAEAhB,EAAAA,GAAG,CAACQ,IAAJ,CAAS;AAAEC,IAAAA,QAAQ,EAAE;AAAZ,GAAT;AACD","sourcesContent":["import crypto from 'crypto';\nimport { serialize } from 'cookie';\nimport { selectUserByUsername, insertSession } from '../../db';\nimport { hashPassword, verifyHashMatchesPassword } from '../../hashing';\nimport { NextApiRequest, NextApiResponse } from 'next';\n\nexport default async function login(req: NextApiRequest, res: NextApiResponse) {\n  // TODO: To secure your application even further,\n  // accept a CSRF token here and verify it\n  // (see pages/register.tsx)\n  const username = req.body.username;\n  const password = req.body.password;\n  const users = await selectUserByUsername(username);\n\n  if (users.length === 0) {\n    console.log('denied login - zero users with that username');\n    res.json({ loggedIn: false });\n    return;\n  }\n\n  if (!(await verifyHashMatchesPassword(users[0].password_hash, password))) {\n    console.log(\"denied login - password doesn't match\");\n    res.json({ loggedIn: false });\n    return;\n  }\n\n  console.log('logged in');\n\n  const maxAge = 60 * 60 * 8; // 8 hours\n  const token = crypto.randomBytes(24).toString('base64');\n\n  await insertSession(users[0].id, token);\n\n  const cookie = serialize('token', token, {\n    maxAge,\n    expires: new Date(Date.now() + maxAge * 1000),\n\n    // Important for security\n    // Deny cookie access from JavaScript\n    httpOnly: true,\n\n    // Important for security\n    // Set secure cookies on production\n    secure: process.env.NODE_ENV === 'production',\n\n    path: '/',\n    sameSite: 'lax',\n  });\n\n  // TODO: In order to prevent your database\n  // from overflowing with sessions, you should\n  // remove the old sessions here.\n\n  res.setHeader('Set-Cookie', cookie);\n\n  res.json({ loggedIn: true });\n}\n"]},"metadata":{},"sourceType":"module"}