{"ast":null,"code":"var _jsxFileName = \"/Users/gabrielasanchez/projects/wolfis-trip/pages/register.tsx\";\nvar __jsx = React.createElement;\nimport React from 'react';\nimport Head from 'next/head';\nimport Header from '../components/Header';\nexport default function Register(props) {\n  return __jsx(React.Fragment, null, __jsx(Head, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 13,\n      columnNumber: 7\n    }\n  }, __jsx(\"title\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 14,\n      columnNumber: 9\n    }\n  }, \"Register\")), __jsx(Header, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 17,\n      columnNumber: 7\n    }\n  }), __jsx(\"h1\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 19,\n      columnNumber: 7\n    }\n  }, \"Register\"), __jsx(\"form\", {\n    method: \"POST\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 21,\n      columnNumber: 7\n    }\n  }, __jsx(\"input\", {\n    name: \"username\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 22,\n      columnNumber: 9\n    }\n  }), __jsx(\"input\", {\n    name: \"password\",\n    type: \"password\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 23,\n      columnNumber: 9\n    }\n  }), __jsx(\"input\", {\n    type: \"hidden\",\n    name: \"csrf\",\n    value: props.csrfToken,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 24,\n      columnNumber: 9\n    }\n  }), __jsx(\"button\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 25,\n      columnNumber: 9\n    }\n  }, \"Register\")));\n}\nexport async function getServerSideProps(context) {\n  // TODO: Do this in an API Route instead!\n  //\n  // This also helps to avoid all of the buffer code\n  // and the query-string dependency below!\n  const queryString = await import('query-string');\n  const {\n    insertUser\n  } = await import('../db');\n  const {\n    hashPassword\n  } = await import('../hashing');\n  const Tokens = (await import('csrf')).default;\n  const tokens = new Tokens();\n  const secret = process.env.CSRF_TOKEN;\n\n  if (typeof secret !== 'string') {\n    throw new Error('Token secret misconfigured!');\n  }\n\n  let buffer = '';\n  context.req.on('data', chunk => {\n    buffer += chunk;\n  });\n  context.req.on('end', async () => {\n    const body = queryString.parse(Buffer.from(buffer).toString());\n\n    if (typeof body.username !== 'string' || typeof body.password !== 'string') {\n      console.log('No username or password passed in body');\n      return;\n    }\n\n    const username = body.username;\n    const passwordHash = await hashPassword(body.password);\n    const requestToken = body.csrf;\n\n    if (typeof requestToken !== 'string') {\n      throw new Error('No CSRF token passed!');\n    }\n\n    if (tokens.verify(secret, requestToken)) {\n      // console.log(user);\n      insertUser(username, passwordHash).then(() => console.log('succeeded')).catch(err => console.error(\"didn't work\", err));\n    } else {\n      console.error('CSRF token not valid!!');\n    }\n  });\n  const props = {\n    csrfToken: tokens.create(secret)\n  };\n  return {\n    props\n  };\n}","map":{"version":3,"sources":["/Users/gabrielasanchez/projects/wolfis-trip/pages/register.tsx"],"names":["React","Head","Header","Register","props","csrfToken","getServerSideProps","context","queryString","insertUser","hashPassword","Tokens","default","tokens","secret","process","env","CSRF_TOKEN","Error","buffer","req","on","chunk","body","parse","Buffer","from","toString","username","password","console","log","passwordHash","requestToken","csrf","verify","then","catch","err","error","create"],"mappings":"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","sourcesContent":["import React from 'react';\nimport { GetServerSidePropsContext } from 'next';\nimport Head from 'next/head';\nimport Header from '../components/Header';\n\ntype Props = {\n  csrfToken: string;\n};\n\nexport default function Register(props: Props) {\n  return (\n    <>\n      <Head>\n        <title>Register</title>\n      </Head>\n\n      <Header />\n\n      <h1>Register</h1>\n\n      <form method=\"POST\">\n        <input name=\"username\" />\n        <input name=\"password\" type=\"password\" />\n        <input type=\"hidden\" name=\"csrf\" value={props.csrfToken} />\n        <button>Register</button>\n      </form>\n    </>\n  );\n}\n\nexport async function getServerSideProps(context: GetServerSidePropsContext) {\n  // TODO: Do this in an API Route instead!\n  //\n  // This also helps to avoid all of the buffer code\n  // and the query-string dependency below!\n\n  const queryString = await import('query-string');\n  const { insertUser } = await import('../db');\n  const { hashPassword } = await import('../hashing');\n\n  const Tokens = (await import('csrf')).default;\n  const tokens = new Tokens();\n\n  const secret = process.env.CSRF_TOKEN;\n  if (typeof secret !== 'string') {\n    throw new Error('Token secret misconfigured!');\n  }\n\n  let buffer = '';\n\n  context.req.on('data', (chunk) => {\n    buffer += chunk;\n  });\n\n  context.req.on('end', async () => {\n    const body = queryString.parse(Buffer.from(buffer).toString());\n\n    if (\n      typeof body.username !== 'string' ||\n      typeof body.password !== 'string'\n    ) {\n      console.log('No username or password passed in body');\n      return;\n    }\n\n    const username = body.username;\n    const passwordHash = await hashPassword(body.password);\n\n    const requestToken = body.csrf;\n\n    if (typeof requestToken !== 'string') {\n      throw new Error('No CSRF token passed!');\n    }\n\n    if (tokens.verify(secret, requestToken)) {\n      // console.log(user);\n      insertUser(username, passwordHash)\n        .then(() => console.log('succeeded'))\n        .catch((err) => console.error(\"didn't work\", err));\n    } else {\n      console.error('CSRF token not valid!!');\n    }\n  });\n\n  const props: Props = {\n    csrfToken: tokens.create(secret),\n  };\n\n  return {\n    props,\n  };\n}\n"]},"metadata":{},"sourceType":"module"}